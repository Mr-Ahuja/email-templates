(function(){
  const $=(s,e=document)=>e.querySelector(s); const $$=(s,e=document)=>e.querySelectorAll(s);
  const esc=(s)=>String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  const clamp=(n,lo=0,hi=100)=>Math.max(lo,Math.min(hi,+n||0));
  const dataUriFromSvg=(code)=>'data:image/svg+xml;utf8,'+encodeURIComponent(code);

  // Light variant by palette transform over Material Dark output
  function buildHtmlHermesLight(cfg){
    const html = typeof buildHtmlMaterialDark === 'function' ? buildHtmlMaterialDark(cfg) : '';
    return html
      .replace(/#0b0c0e/gi,'#F5F7FA')
      .replace(/#121212/gi,'#FFFFFF')
      .replace(/#1a1a1a/gi,'#FFFFFF')
      .replace(/#191919/gi,'#FFFFFF')
      .replace(/#222/gi,'#E5E7EB')
      .replace(/#2a2a2a/gi,'#E5E7EB')
      .replace(/#cdd3d8/gi,'#374151')
      .replace(/#dde3e8/gi,'#1F2937')
      .replace(/#e6e6e6/gi,'#111827')
      .replace(/#9aa0a6/gi,'#6B7280')
      .replace(/#00bcd4/gi,'#2D7FF9');
  }

  // Brutalist Neon minimal variant (compact unique look)
  function buildHtmlBrutalistNeon(cfg){
    const e=(s)=>String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#39;');
    const c=(n)=>Math.max(0,Math.min(100,+n||0));
    const name=String(cfg.projectName||'PROJECT'); const icon=String(cfg.projectIconUrl||'');
    const date=String(cfg.updateDate||new Date().toISOString().slice(0,10));
    const pre=String(cfg.preheader||'Status brief'); const summary=String(cfg.updateSummary||'');
    const pct=c(cfg.progressPercent); const ws=cfg.workstreams||[]; const ms=cfg.milestones||[]; const track=c(cfg.milestoneTrackPercent);
    const cta=cfg.cta||{}; const ctaLabel=cta.label||'OPEN'; const ctaUrl=cta.url||'#';
    const ACC=String(cfg.accentColor||'#FF2D9B'); const ACC2=String(cfg.accentAltColor||'#00FFD1');
    const ascii=(p,l=28)=>{p=c(p);const f=Math.round(p/100*l);return '['+'█'.repeat(f)+'░'.repeat(Math.max(0,l-f))+`] ${p}%`;};
    const wsHtml=ws.map(w=>`<tr><td style="padding:6px 0;font:12px Consolas,monospace;color:#111">${e(w.label||'')}</td><td align="right" style="padding:6px 0;font:12px Consolas,monospace;color:#111">${c(w.percent)}%</td></tr><tr><td colspan="2" style="font:12px Consolas,monospace;color:#111">${e(ascii(c(w.percent),24))}</td></tr>`).join('');
    const msl=!ms.length?'':`<table role="presentation" width="100%"><tr>${ms.map(m=>`<td align=\"center\" style=\"width:${(100/ms.length).toFixed(2)}%\"><div style=\"height:16px\"><span style=\"display:inline-block;width:2px;height:16px;background:${ACC}\"></span></div><div style=\"font:12px Consolas,monospace;color:#111;margin-top:6px\">${e(m.label||'')}</div><div style=\"font:11px Consolas,monospace;color:#4B5563\">${e(m.date||'')}</div></td>`).join('')}</tr></table>`;
    return `<!DOCTYPE html><html><head><meta charset=\"utf-8\"><meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"><title>${e(name)} — Brief</title></head><body style=\"margin:0;background:#0F0F0F;color:#111\"><div style=\"display:none;max-height:0;overflow:hidden;opacity:0\">${e(pre)}</div><table role=\"presentation\" width=\"100%\" style=\"background:#0F0F0F\"><tr><td align=\"center\" style=\"padding:24px\"><table role=\"presentation\" width=\"680\" style=\"background:#FFFFFF;border:4px solid #000\"><tr><td style=\"padding:10px 16px;background:${ACC};font:700 12px Consolas,monospace;letter-spacing:1px\">STATUS BRIEF · ${e(date)}</td></tr><tr><td style=\"padding:16px;border-bottom:4px solid #000\"><table width=\"100%\"><tr><td width=\"60\"><img src=\"${e(icon)}\" width=\"56\" height=\"56\" alt=\"${e(name)} icon\" style=\"display:block;border:3px solid #000;background:#fff\"></td><td style=\"padding-left:12px\"><div style=\"font:11px Consolas,monospace;color:#111\">PROJECT</div><div style=\"font:28px Impact,'Arial Black',Arial;color:#000;text-transform:uppercase\">${e(name)}</div></td><td align=\"right\" style=\"font:11px Consolas,monospace;color:#111\">${e(date)}</td></tr></table></td></tr><tr><td style=\"padding:12px 16px 0\"><div style=\"font:15px Arial;color:#111\">${e(summary).replace(/\n/g,'<br>')}</div><div style=\"margin-top:8px;font:13px Consolas,monospace;color:#111\">${e(ascii(pct,28))}</div><div style=\"background:#000;height:2px;margin-top:6px\"></div><div style=\"background:${ACC2};height:6px;width:${pct}%;margin-top:-4px\"></div></td></tr><tr><td style=\"padding:12px 16px 0\"><table role=\"presentation\" width=\"100%\" style=\"border:3px solid #000\"><tr><td style=\"padding:10px;background:${ACC2};font:700 12px Consolas,monospace\">WORKSTREAMS</td></tr><tr><td style=\"padding:8px 12px\"><table role=\"presentation\" width=\"100%\">${wsHtml}</table></td></tr></table></td></tr><tr><td style=\"padding:12px 16px 0\"><table role=\"presentation\" width=\"100%\" style=\"border:3px solid #000\"><tr><td style=\"padding:10px;background:${ACC};font:700 12px Consolas,monospace\">ROUTE</td></tr><tr><td style=\"padding:12px\"><div style=\"background:#000;height:2px\"></div><div style=\"background:${ACC};height:6px;width:${track}%;margin-top:-4px\"></div><div style=\"margin-top:8px\">${msl}</div></td></tr></table></td></tr><tr><td style=\"padding:16px\"><a href=\"${e(ctaUrl)}\" style=\"display:inline-block;min-width:260px;text-align:center;text-decoration:none;background:${ACC2};color:#000;border:3px solid #000;font:800 14px/48px Arial;letter-spacing:1px\">${e(ctaLabel)}</a></td></tr></table></td></tr></table></body></html>`;
  }

  function buildHtmlMaterialDark(cfg){
    const name=String(cfg.projectName||'Project'); const icon=String(cfg.projectIconUrl||'');
    const date=String(cfg.updateDate||new Date().toISOString().slice(0,10));
    const pre=String(cfg.preheader||`Weekly update for ${name}`);
    const summary=String(cfg.updateSummary||''); const pct=clamp(cfg.progressPercent);
    const whats=cfg.whatsNew||[]; const risks=cfg.risks||[]; const ws=cfg.workstreams||[]; const ms=cfg.milestones||[]; const track=clamp(cfg.milestoneTrackPercent);
    const cta=cfg.cta||{}; const ctaLabel=cta.label||'Open'; const ctaUrl=cta.url||'#';
    const wl=(!whats.length)?'<li>â€”</li>':whats.map(x=>`<li>${esc(x)}</li>`).join('');
    const rl=(!risks.length)?'<li>â€”</li>':risks.map(x=>`<li>${esc(x)}</li>`).join('');
    const wsl=!ws.length?'':ws.map(w=>{const p=clamp(w.percent);return `<div style="margin:8px 0"><div style="font:13px Segoe UI,Arial;color:#CDD3D8">${esc(w.label||'')}</div><div style="height:8px;background:#2a2a2a;border-radius:9999px;overflow:hidden"><div style="width:${p}%;height:8px;background:#00bcd4"></div></div></div>`}).join('');
    const msl=!ms.length?'':`<table role="presentation" width="100%"><tr>${ms.map(m=>`<td align="center" style="width:${(100/ms.length).toFixed(2)}%"><div style="height:10px"><span style="display:inline-block;width:10px;height:10px;border-radius:9999px;background:#2a2a2a;border:1px solid #3a3a3a"></span></div><div style="font:12px Segoe UI,Arial;color:#CDD3D8;margin-top:6px">${esc(m.label||'')}</div><div style="font:11px Segoe UI,Arial;color:#9aa0a6">${esc(m.date||'')}</div></td>`).join('')}</tr></table>`;
    const footer=cfg.footerHtml?cfg.footerHtml.replace(/\{\{PROJECT_NAME\}\}/g,esc(name)):(cfg.footerText?`<div style="font:12px Segoe UI,Arial;color:#7f8b95">${esc(cfg.footerText.replace(/\{\{PROJECT_NAME\}\}/g,name))}</div>`:`<div style="font:12px Segoe UI,Arial;color:#7f8b95">You are receiving this update about <span style="color:#C9D1D9">${esc(name)}</span>.</div>`);
    return `<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="color-scheme" content="dark"><title>${esc(name)} â€” Update</title></head><body style="margin:0;background:#0b0c0e;color:#e6e6e6"><div style="display:none;max-height:0;overflow:hidden;opacity:0">${esc(pre)}</div><table role="presentation" width="100%" style="background:#0b0c0e"><tr><td align="center" style="padding:24px"><table role="presentation" width="640" style="width:640px;max-width:640px;background:#121212;border-radius:16px"><tr><td style="padding:20px 24px 12px"><table width="100%"><tr><td width="52"><img src="${esc(icon)}" width="48" height="48" alt="${esc(name)} icon" style="display:block;border-radius:10px;background:#1e1e1e"></td><td style="padding-left:12px"><div style="font:12px Segoe UI,Arial;color:#b0b3b8;letter-spacing:.3px">Project Update</div><div style="font:700 24px/28px Segoe UI,Arial;color:#e6e6e6">${esc(name)}</div></td><td align="right" style="font:12px Segoe UI,Arial;color:#9aa0a6">${esc(date)}</td></tr></table></td></tr><tr><td style="padding:0 24px"><div style="height:1px;background:#222"></div></td></tr><tr><td style="padding:16px 24px 0"><div style="font:14px/20px Segoe UI,Arial;color:#dde3e8">${esc(summary).replace(/\n/g,'<br>')}</div></td></tr><tr><td style="padding:16px 24px 0"><div style="font:12px Segoe UI,Arial;color:#9aa0a6">Overall Progress: <span style="color:#e6e6e6;font-weight:600">${pct}%</span></div><div style="height:10px;background:#2a2a2a;border-radius:9999px;overflow:hidden;margin-top:8px"><div style="width:${pct}%;height:10px;background:#00bcd4"></div></div></td></tr><tr><td style="padding:16px 24px 0"><table role="presentation" width="100%" style="background:#1a1a1a;border-radius:12px"><tr><td style="padding:16px"><div style="font:600 14px/20px Segoe UI,Arial;color:#e6e6e6;margin-bottom:8px">Whatâ€™s New</div><ul style="padding-left:18px;margin:0;font:13px/20px Segoe UI,Arial;color:#cdd3d8">${wl}</ul></td></tr></table></td></tr><tr><td style="padding:12px 24px 0"><table role="presentation" width="100%" style="background:#1a1a1a;border-radius:12px"><tr><td style="padding:16px"><div style="font:600 14px/20px Segoe UI,Arial;color:#e6e6e6;margin-bottom:8px">Workstream Progress</div>${wsl}</td></tr></table></td></tr><tr><td style="padding:12px 24px 0"><table role="presentation" width="100%" style="background:#191919;border-radius:12px"><tr><td style="padding:16px"><div style="font:600 14px/20px Segoe UI,Arial;color:#e6e6e6;margin-bottom:8px">Milestone Track</div><div style="height:8px;background:#2a2a2a;border-radius:9999px;overflow:hidden"><div style="width:${track}%;height:8px;background:#00bcd4"></div></div><div style="margin-top:8px">${msl}</div></td></tr></table></td></tr><tr><td style="padding:12px 24px 0"><table role="presentation" width="100%" style="background:#191919;border-radius:12px"><tr><td style="padding:16px"><div style="font:600 14px/20px Segoe UI,Arial;color:#e6e6e6;margin-bottom:8px">Risks & Blockers</div><ul style="padding-left:18px;margin:0;font:13px/20px Segoe UI,Arial;color:#e0b2b2">${rl}</ul></td></tr></table></td></tr><tr><td style="padding:20px 24px 24px"><a href="${esc(ctaUrl)}" style="display:inline-block;min-width:220px;text-align:center;text-decoration:none;background:#00bcd4;color:#000;border-radius:6px;font:700 14px/44px Segoe UI,Arial">${esc(ctaLabel)}</a></td></tr><tr><td style="padding:0 24px 20px"><div style="height:1px;background:#222"></div></td></tr><tr><td style="padding:8px 24px 24px">${footer}</td></tr></table></td></tr></table></body></html>`;
  }

  const TEMPLATES=[
    { id:"material-dark-update", name:"Material Dark — Project Update", description:"Dark Material look with progress bars and milestones.", sampleConfig:`{
  "projectName":"Nebula CRM","projectIconUrl":"https://example.com/icon.png","updateDate":"2025-11-10","preheader":"Weekly update — highlights, risks, and next steps.","updateSummary":"We completed the onboarding flow revamp, improved sync reliability, and began the dashboard filters work.","progressPercent":68,"whatsNew":["Onboarding flow redesigned","API rate limiter tuned","Dashboard filter presets"],"risks":["Billing SDK upgrade pending","Export job CPU spikes"],"workstreams":[{"label":"Frontend Revamp","percent":80},{"label":"Sync Service","percent":62}],"milestoneTrackPercent":60,"milestones":[{"label":"Spec","date":"Sep 18"},{"label":"MVP","date":"Oct 10"},{"label":"Beta","date":"Oct 28"}],"cta":{"label":"View Dashboard","url":"https://example.com"},"footerText":"You are receiving this update about {{PROJECT_NAME}}." }`, buildHtml:buildHtmlMaterialDark },
    { id:"mythic-light-hermes", name:"Mythic Light — Hermes Update", description:"Light theme with subtle Greek myth accents.", sampleConfig:`{
  "projectName":"Project Hermes","projectIconUrl":"https://example.com/hermes-icon.png","updateDate":"2025-11-10","preheader":"Hermes dispatch — weekly status and next steps.","updateSummary":"Swift progress on the messaging relays and route optimization.","progressPercent":72,"sections":[{"title":"What’s New","items":["Relay pipeline refactor","Courier offline queue"]},{"title":"Headwinds","items":["Map tiles quota","Webhook retry cascades"]}],"workstreams":[{"label":"Relays","percent":80},{"label":"Courier App","percent":65}],"milestoneTrackPercent":55,"milestones":[{"label":"Spec","date":"Oct 12"},{"label":"Prototype","date":"Nov 08"},{"label":"Beta","date":"Dec 05"}],"cta":{"label":"Open Dispatch Console","url":"https://example.com/hermes"},"footerText":"Dispatch notice for {{PROJECT_NAME}}." }`, buildHtml:buildHtmlHermesLight },
    { id:"brutalist-neon", name:"Brutalist Neon — Status Brief", description:"Unorthodox neon brutalist layout with ASCII bars and bold blocks.", sampleConfig:`{
  "projectName":"Project Hermes","projectIconUrl":"https://example.com/hermes-icon.png","updateDate":"2025-11-10","preheader":"Status brief — neon brutalist.","updateSummary":"Blunt, bold, and bright: key signals and next actions.","progressPercent":64,"workstreams":[{"label":"Relays","percent":80},{"label":"Courier App","percent":58},{"label":"Routing","percent":31}],"milestoneTrackPercent":54,"milestones":[{"label":"Spec","date":"Oct 10"},{"label":"Proto","date":"Nov 05"},{"label":"Beta","date":"Dec 01"}],"cta":{"label":"OPEN CONSOLE","url":"https://example.com/hermes"},"accentColor":"#FF2D9B","accentAltColor":"#00FFD1","footerText":"Brief for {{PROJECT_NAME}} — manage prefs in your profile." }`, buildHtml:buildHtmlBrutalistNeon }
  ];

  // Storage v2
  const STORE_KEY='emailBuilder.projects.v2'; let store={projects:{}};
  const uid=()=>('p_'+Math.random().toString(36).slice(2,10)+Date.now().toString(36).slice(-4));
  const loadStore=()=>{ try{const s=localStorage.getItem(STORE_KEY); store=s?JSON.parse(s):{projects:{}};}catch{store={projects:{}};} };
  const saveStore=()=> localStorage.setItem(STORE_KEY, JSON.stringify(store));
  const projectsList=()=>Object.values(store.projects).sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));

  // App state
  let currentProjectId=null, currentVersionId=null, currentConfig={};

  // DOM refs
  const dashboardView=$('#dashboard-view'), projectView=$('#project-view');
  const tmplList=$('#tmpl-list'), projList=$('#proj-list');
  const projNameInput=$('#proj-name-input'), toInput=$('#to'), subjectInput=$('#subject');
  const versionList=$('#version-list'), formPane=$('#form-pane'), jsonPane=$('#json-pane'), editor=$('#config-editor');
  const livePreview=$('#live-preview'), projTemplateName=$('#proj-template-name'), statusBar=$('#status-bar');

  const writePreview=(html)=>{ try{const d=livePreview.contentDocument; d.open(); d.write(html); d.close();}catch{}}
  let prevTimer=null; const schedulePreview=()=>{ clearTimeout(prevTimer); prevTimer=setTimeout(()=>{ writePreview(getTemplate().buildHtml(currentConfig)); },80); };
  const getTemplate=()=>{ const p=store.projects[currentProjectId]; return TEMPLATES.find(t=>t.id===p.templateId)||TEMPLATES[0]; };

  function renderDashboard(){ dashboardView.style.display=''; projectView.style.display='none'; tmplList.innerHTML=''; TEMPLATES.forEach(t=>{ const card=document.createElement('div'); card.className='card'; card.innerHTML=`<h3>${t.name}</h3><p>${t.description}</p><div class="controls"><button class="btn">Create</button></div>`; card.querySelector('button').addEventListener('click',()=>createProject(t.id)); tmplList.appendChild(card); }); projList.innerHTML=''; projectsList().forEach(p=>{ const item=document.createElement('div'); item.className='list-item'; item.innerHTML=`<div><div class="title">${esc(p.name)}</div><div class="meta">${esc(p.templateId)} â€¢ ${(p.versions||[]).length} versions</div></div>`; const act=document.createElement('div'); act.className='controls'; const open=document.createElement('button'); open.className='btn'; open.textContent='Open'; open.addEventListener('click',()=>openProject(p.id)); const del=document.createElement('button'); del.className='btn ghost'; del.textContent='Delete'; del.addEventListener('click',()=>{ if(confirm('Delete project?')){ delete store.projects[p.id]; saveStore(); renderDashboard(); } }); act.appendChild(open); act.appendChild(del); item.appendChild(act); projList.appendChild(item); }); }
  function createProject(tid){ const t=TEMPLATES.find(x=>x.id===tid)||TEMPLATES[0]; const id=uid(); const now=Date.now(); const vid=uid(); const cfg=JSON.parse(t.sampleConfig); store.projects[id]={id,name:cfg.projectName||'New Project',templateId:t.id,createdAt:now,updatedAt:now,versions:[{id:vid,name:'v1',config:cfg,isDraft:true,createdAt:now,updatedAt:now}]}; saveStore(); openProject(id,vid); }
  function openProject(pid,vid){ currentProjectId=pid; const p=store.projects[pid]; if(!p) return; dashboardView.style.display='none'; projectView.style.display=''; projTemplateName.textContent=(TEMPLATES.find(t=>t.id===p.templateId)?.name)||p.templateId; projNameInput.value=p.name; if(!vid){ const vs=(p.versions||[]).slice().sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0)); vid=vs[0]?.id; } currentVersionId=vid; const v=p.versions.find(x=>x.id===vid); currentConfig=JSON.parse(JSON.stringify(v.config||{})); editor.value=JSON.stringify(currentConfig,null,2); subjectInput.value=`Weekly Update â€” ${currentConfig.projectName||p.name}`; renderVersionList(); renderFormFromConfig(currentConfig,p.templateId); schedulePreview(); }
  function renderVersionStrip(){ const p=store.projects[currentProjectId]; const cont=document.getElementById('version-strip'); if(!cont||!p) return; cont.innerHTML=''; (p.versions||[]).sort((a,b)=>(a.createdAt||0)-(b.createdAt||0)).forEach(v=>{ const chip=document.createElement('button'); chip.className='chip'+(v.id===currentVersionId?' active':''); chip.type='button'; chip.textContent=v.name; chip.title=new Date(v.updatedAt).toLocaleString(); chip.addEventListener('click',()=>openProject(currentProjectId, v.id)); cont.appendChild(chip); }); }
  function renderVersionList(){ const p=store.projects[currentProjectId]; const vlist=document.getElementById('version-list'); if(!vlist){ renderVersionStrip(); return; } vlist.innerHTML=''; (p.versions||[]).sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0)).forEach(v=>{ const item=document.createElement('div'); item.className='list-item'+(v.id===currentVersionId?' version-active':''); item.innerHTML=`<div><div class="title">${esc(v.name)}</div><div class="meta">${new Date(v.updatedAt).toLocaleString()}</div></div>`; const act=document.createElement('div'); act.className='controls'; const open=document.createElement('button'); open.className='btn ghost'; open.textContent='Open'; open.addEventListener('click',()=>openProject(currentProjectId,v.id)); const ren=document.createElement('button'); ren.className='btn ghost'; ren.textContent='Rename'; ren.addEventListener('click',()=>{ const n=prompt('Version name',v.name)||v.name; v.name=n; v.updatedAt=Date.now(); saveStore(); renderVersionList(); renderVersionStrip(); }); const dup=document.createElement('button'); dup.className='btn ghost'; dup.textContent='Duplicate'; dup.addEventListener('click',()=>{ const nv={id:uid(),name:v.name+' copy',config:JSON.parse(JSON.stringify(v.config)),isDraft:true,createdAt:Date.now(),updatedAt:Date.now()}; p.versions.push(nv); p.updatedAt=Date.now(); saveStore(); renderVersionList(); renderVersionStrip(); }); const del=document.createElement('button'); del.className='btn ghost'; del.textContent='Delete'; del.addEventListener('click',()=>{ if(confirm('Delete version?')){ const ix=p.versions.findIndex(x=>x.id===v.id); if(ix>=0){ p.versions.splice(ix,1); p.updatedAt=Date.now(); saveStore(); if(currentVersionId===v.id && p.versions.length){ openProject(currentProjectId,p.versions[0].id);} else { renderVersionList(); renderVersionStrip(); } } }}); act.appendChild(open); act.appendChild(ren); act.appendChild(dup); act.appendChild(del); item.appendChild(act); vlist.appendChild(item); }); renderVersionStrip(); }

  function deepSet(obj,path,val){ const parts=path.split('.'); let cur=obj; for(let i=0;i<parts.length-1;i++){ const k=parts[i]; if(cur[k]==null||typeof cur[k]!=='object') cur[k]={}; cur=cur[k]; } cur[parts[parts.length-1]]=val; }
  function inferType(key,val){ if(Array.isArray(val)) return 'list'; if(typeof val==='number') return key.toLowerCase().includes('percent')?'percent':'number'; if(typeof val==='boolean') return 'checkbox'; if(typeof val==='string'){ const lk=key.toLowerCase(); if(lk.includes('url')||lk.includes('icon')) return 'image'; if(lk.includes('summary')||lk.includes('footer')) return 'textarea'; return 'text'; } if(typeof val==='object'&&val) return 'group'; return 'text'; }
  function buildPrimitiveInput(path,label,type,value,onChange){ const wrap=document.createElement('div'); wrap.style.marginBottom='10px'; const id='f_'+path.replace(/[^a-z0-9]+/gi,'_')+'_'+Math.random().toString(36).slice(2,6); const lab=document.createElement('label'); lab.className='muted'; lab.textContent=label; lab.htmlFor=id; wrap.appendChild(lab); if(type==='textarea'){ const ta=document.createElement('textarea'); ta.id=id; ta.className='input'; ta.style.minHeight='80px'; ta.value=value||''; ta.addEventListener('input',()=>onChange(ta.value)); wrap.appendChild(ta); return wrap; } if(type==='checkbox'){ const cb=document.createElement('input'); cb.id=id; cb.type='checkbox'; cb.checked=!!value; cb.addEventListener('change',()=>onChange(cb.checked)); wrap.appendChild(cb); return wrap; } if(type==='percent'){ const row=document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; const num=document.createElement('input'); num.id=id; num.type='number'; num.className='input'; num.min='0'; num.max='100'; num.step='1'; num.style.maxWidth='120px'; num.value=(value??0); num.addEventListener('input',()=>onChange(clamp(num.value))); const rng=document.createElement('input'); rng.type='range'; rng.min='0'; rng.max='100'; rng.step='1'; rng.value=(value??0); rng.setAttribute('aria-labelledby',id); rng.addEventListener('input',()=>{ num.value=rng.value; onChange(clamp(rng.value)); }); row.appendChild(num); row.appendChild(rng); wrap.appendChild(row); return wrap; } if(type==='image'){ const grp=document.createElement('div'); grp.className='controls'; grp.setAttribute('role','group'); grp.setAttribute('aria-label','Image input mode'); const urlBtn=document.createElement('button'); urlBtn.className='btn'; urlBtn.textContent='URL'; const svgBtn=document.createElement('button'); svgBtn.className='btn ghost'; svgBtn.textContent='SVG code'; const genBtn=document.createElement('button'); genBtn.className='btn ghost'; genBtn.textContent='SVG from name'; const url=document.createElement('input'); url.id=id; url.type='text'; url.className='input'; url.placeholder='https://...'; url.value=value||''; url.style.marginTop='6px'; const svg=document.createElement('textarea'); svg.className='input'; svg.style.display='none'; svg.style.minHeight='100px'; svg.placeholder='<svg>...</svg>'; const prev=document.createElement('img'); prev.alt='preview'; prev.style.width='44px'; prev.style.height='44px'; prev.style.borderRadius='8px'; prev.style.border='1px solid #2a2a2a'; prev.style.marginLeft='8px'; function useURL(){ urlBtn.className='btn'; svgBtn.className='btn ghost'; url.style.display=''; svg.style.display='none'; prev.src=url.value; onChange(url.value);} function useSVG(){ urlBtn.className='btn ghost'; svgBtn.className='btn'; url.style.display='none'; svg.style.display=''; const v=svg.value.trim(); const data=v?dataUriFromSvg(v):''; prev.src=data; onChange(data);} function genSVG(){ const code=`<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"128\" height=\"128\"><rect width=\"100%\" height=\"100%\" fill=\"#00FFD1\"/><text x=\"50%\" y=\"54%\" dy=\".1em\" text-anchor=\"middle\" font-family=\"Segoe UI, Arial, sans-serif\" font-size=\"56\" fill=\"#000\">${esc((String(currentConfig.projectName||'P')||'P').charAt(0).toUpperCase())}</text></svg>`; svg.value=code; useSVG(); } url.addEventListener('input',()=>{ prev.src=url.value; onChange(url.value);}); svg.addEventListener('input',()=>useSVG()); urlBtn.addEventListener('click',e=>{e.preventDefault();useURL();}); svgBtn.addEventListener('click',e=>{e.preventDefault();useSVG();}); genBtn.addEventListener('click',e=>{e.preventDefault();genSVG();}); grp.appendChild(urlBtn); grp.appendChild(svgBtn); grp.appendChild(genBtn); grp.appendChild(prev); wrap.appendChild(grp); wrap.appendChild(url); wrap.appendChild(svg); useURL(); return wrap; } const inp=document.createElement('input'); inp.id=id; inp.type=(type==='number'?'number':'text'); inp.className='input'; inp.value=(value??''); inp.addEventListener('input',()=>onChange(inp.value)); wrap.appendChild(inp); return wrap; }
  function buildListPrimitive(path,label,arr,onChange){ const wrap=document.createElement('div'); const title=document.createElement('div'); title.className='muted'; title.textContent=label; wrap.appendChild(title); const list=document.createElement('div'); wrap.appendChild(list); function render(){ list.innerHTML=''; (arr||[]).forEach((val,idx)=>{ const row=document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.margin='6px 0'; const inp=document.createElement('input'); inp.type='text'; inp.className='input'; inp.style.flex='1'; inp.value=val||''; inp.addEventListener('input',()=>{ arr[idx]=inp.value; onChange(arr);}); const del=document.createElement('button'); del.className='btn ghost'; del.innerHTML='<svg style="width:14px;height:14px;vertical-align:-2px;margin-right:6px" viewBox="0 0 24 24" fill="currentColor"><path d="M6 7h12l-1 14H7L6 7zm3-3h6l1 2H8l1-2z"/></svg>Remove'; del.addEventListener('click',e=>{e.preventDefault();arr.splice(idx,1);onChange(arr);render();}); row.appendChild(inp); row.appendChild(del); list.appendChild(row);}); } const add=document.createElement('button'); add.className='btn secondary'; add.innerHTML='<svg style="width:14px;height:14px;vertical-align:-2px;margin-right:6px" viewBox="0 0 24 24" fill="currentColor"><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></svg>Add Item'; add.addEventListener('click',e=>{e.preventDefault();arr.push('');onChange(arr);render();}); render(); wrap.appendChild(add); return wrap; }
  function buildListObjects(path,label,arr,itemSpec,onChange){ const wrap=document.createElement('div'); const title=document.createElement('div'); title.className='muted'; title.textContent=label; wrap.appendChild(title); const listDiv=document.createElement('div'); wrap.appendChild(listDiv); function render(){ listDiv.innerHTML=''; (arr||[]).forEach((obj,idx)=>{ const card=document.createElement('div'); card.className='panel'; card.style.padding='12px'; card.style.margin='8px 0'; const head=document.createElement('div'); head.className='muted'; head.textContent=`Item ${idx+1}`; card.appendChild(head); const grid=document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(auto-fit,minmax(160px,1fr))'; grid.style.gap='8px'; itemSpec.forEach(f=>{ const key=f.path; const t=f.type||inferType(key,obj[key]); const val=obj[key]; const ctl=buildPrimitiveInput(`${path}.${idx}.${key}`, f.label||key, t, val, nv=>{ obj[key]=(t==='percent'?clamp(nv):(t==='number'?(+nv||0):(t==='checkbox'?!!nv:nv))); onChange(arr);}); grid.appendChild(ctl);}); const del=document.createElement('button'); del.className='btn ghost'; del.innerHTML='<svg style="width:14px;height:14px;vertical-align:-2px;margin-right:6px" viewBox="0 0 24 24" fill="currentColor"><path d="M6 7h12l-1 14H7L6 7zm3-3h6l1 2H8l1-2z"/></svg>Remove'; del.addEventListener('click',e=>{e.preventDefault();arr.splice(idx,1);onChange(arr);render();}); card.appendChild(grid); card.appendChild(del); listDiv.appendChild(card);}); } const add=document.createElement('button'); add.className='btn secondary'; add.innerHTML='<svg style="width:14px;height:14px;vertical-align:-2px;margin-right:6px" viewBox="0 0 24 24" fill="currentColor"><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></svg>Add Item'; add.addEventListener('click',e=>{e.preventDefault();arr.push({});onChange(arr);render();}); render(); wrap.appendChild(add); return wrap; }
  function renderFormFromConfig(cfg, templateId){ const container=$('#dynamic-form'); container.innerHTML=''; const scalarOrder=['projectName','projectIconUrl','bannerUrl','updateDate','preheader','updateSummary','progressPercent','sprintNumber','etaDate','statusLabel','milestoneTrackPercent','currentMilestoneIndex','accentColor','accentAltColor','spotlight','footerText','footerHtml']; const scalars=document.createElement('div'); scalarOrder.forEach(k=>{ if(k in cfg){ const t=inferType(k,cfg[k]); const ctl=buildPrimitiveInput(k,k,t,cfg[k],nv=>{ if(t==='percent') nv=clamp(nv); deepSet(currentConfig,k,nv); editor.value=JSON.stringify(currentConfig,null,2); schedulePreview();}); scalars.appendChild(ctl);} }); if(scalars.childNodes.length){ const sec=document.createElement('div'); const h=document.createElement('h3'); h.textContent='Basics'; h.style.fontSize='14px'; h.style.color='#cfd5db'; h.style.margin='4px 0 8px'; sec.appendChild(h); sec.appendChild(scalars); container.appendChild(sec);} [['statusChip','Status Chip'],['cta','Call To Action'],['quote','Quote']].forEach(([key,label])=>{ if(cfg[key]&&typeof cfg[key]==='object'){ const sec=document.createElement('div'); const h=document.createElement('h3'); h.textContent=label; h.style.fontSize='14px'; h.style.color='#cfd5db'; h.style.margin='8px 0'; sec.appendChild(h); const grid=document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='repeat(auto-fit,minmax(160px,1fr))'; grid.style.gap='8px'; Object.keys(cfg[key]).forEach(sub=>{ const p=`${key}.${sub}`; const t=inferType(sub,cfg[key][sub]); const ctl=buildPrimitiveInput(p,sub,t,cfg[key][sub],nv=>{ if(t==='percent') nv=clamp(nv); deepSet(currentConfig,p,nv); editor.value=JSON.stringify(currentConfig,null,2); schedulePreview();}); grid.appendChild(ctl);}); sec.appendChild(grid); container.appendChild(sec);} }); [['whatsNew','Whatâ€™s New'],['risks','Risks & Blockers']].forEach(([key,label])=>{ if(Array.isArray(cfg[key])){ const wrap=buildListPrimitive(key,label,cfg[key],arr=>{ deepSet(currentConfig,key,arr); editor.value=JSON.stringify(currentConfig,null,2); schedulePreview();}); const sec=document.createElement('div'); const h=document.createElement('h3'); h.textContent=label; h.style.fontSize='14px'; h.style.color='#cfd5db'; h.style.margin='8px 0'; sec.appendChild(h); sec.appendChild(wrap); container.appendChild(sec);} }); if(Array.isArray(cfg.workstreams)){ const wrap=buildListObjects('workstreams','Workstreams',cfg.workstreams,[{path:'label',label:'Label',type:'text'},{path:'percent',label:'Percent',type:'percent'}],arr=>{ deepSet(currentConfig,'workstreams',arr); editor.value=JSON.stringify(currentConfig,null,2); schedulePreview();}); const sec=document.createElement('div'); const h=document.createElement('h3'); h.textContent='Workstreams'; h.style.fontSize='14px'; h.style.color='#cfd5db'; h.style.margin='8px 0'; sec.appendChild(h); sec.appendChild(wrap); container.appendChild(sec);} if(Array.isArray(cfg.milestones)){ const wrap=buildListObjects('milestones','Milestones',cfg.milestones,[{path:'label',label:'Label',type:'text'},{path:'date',label:'Date',type:'text'},{path:'current',label:'Current',type:'checkbox'}],arr=>{ deepSet(currentConfig,'milestones',arr); editor.value=JSON.stringify(currentConfig,null,2); schedulePreview();}); const sec=document.createElement('div'); const h=document.createElement('h3'); h.textContent='Milestones'; h.style.fontSize='14px'; h.style.color='#cfd5db'; h.style.margin='8px 0'; sec.appendChild(h); sec.appendChild(wrap); container.appendChild(sec);} if(Array.isArray(cfg.contributors)){ const wrap=buildListObjects('contributors','Contributors',cfg.contributors,[{path:'name',label:'Name',type:'text'},{path:'imageUrl',label:'Image',type:'image'}],arr=>{ deepSet(currentConfig,'contributors',arr); editor.value=JSON.stringify(currentConfig,null,2); schedulePreview();}); const sec=document.createElement('div'); const h=document.createElement('h3'); h.textContent='Contributors'; h.style.fontSize='14px'; h.style.color='#cfd5db'; h.style.margin='8px 0'; sec.appendChild(h); sec.appendChild(wrap); container.appendChild(sec);} }

  // Wire actions
  $('#back-dashboard').addEventListener('click',()=>renderDashboard());
  $('#add-version').addEventListener('click',()=>{ const p=store.projects[currentProjectId]; const base=JSON.parse(JSON.stringify(currentConfig)); const v={id:uid(),name:`v${(p.versions?.length||0)+1}`,config:base,isDraft:true,createdAt:Date.now(),updatedAt:Date.now()}; p.versions.push(v); p.updatedAt=Date.now(); saveStore(); openProject(currentProjectId,v.id); });
  // Collapse/expand versions list
  const toggleBtn = document.getElementById('toggle-versions');
  if (toggleBtn) {
    toggleBtn.addEventListener('click', ()=>{
      const list = document.getElementById('version-list');
      const expanded = toggleBtn.getAttribute('aria-expanded') === 'true';
      toggleBtn.setAttribute('aria-expanded', expanded ? 'false' : 'true');
      toggleBtn.textContent = expanded ? 'Expand' : 'Collapse';
      if (list) list.style.display = expanded ? 'none' : '';
    });
  }
  $('#mode-form').addEventListener('click',e=>{e.preventDefault(); formPane.style.display=''; jsonPane.style.display='none'; $('#mode-form').className='btn'; $('#mode-json').className='btn secondary';});
  $('#mode-json').addEventListener('click',e=>{e.preventDefault(); formPane.style.display='none'; jsonPane.style.display=''; $('#mode-form').className='btn secondary'; $('#mode-json').className='btn';});
  $('#sync-from-json').addEventListener('click',()=>{ try{ currentConfig=JSON.parse(editor.value); const p=store.projects[currentProjectId]; const v=p.versions.find(x=>x.id===currentVersionId); v.config=JSON.parse(JSON.stringify(currentConfig)); v.updatedAt=Date.now(); p.updatedAt=v.updatedAt; saveStore(); renderFormFromConfig(currentConfig,p.templateId); schedulePreview(); statusBar.textContent='Synced from JSON'; setTimeout(()=>statusBar.textContent='',1200);}catch(e){ alert('Invalid JSON: '+e.message);} });
  function buildEml(to,subject,html){ const h=[`From: `,`To: ${to||''}`,`Subject: ${subject||''}`,`MIME-Version: 1.0`,`Content-Type: text/html; charset=UTF-8`,`Content-Transfer-Encoding: 8bit`,''].join('\r\n'); return h+html; }
  $('#copy-html').addEventListener('click',async()=>{ try{ await navigator.clipboard.writeText(getTemplate().buildHtml(currentConfig)); statusBar.textContent='HTML copied'; setTimeout(()=>statusBar.textContent='',1200);}catch(e){ alert('Copy failed: '+e.message);} });
  $('#download-html').addEventListener('click',()=>{ const html=getTemplate().buildHtml(currentConfig); const name=(store.projects[currentProjectId]?.name||'project').toLowerCase().replace(/[^a-z0-9]+/g,'-'); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([html],{type:'text/html;charset=utf-8'})); a.download=`${name}-${Date.now()}.html`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1200); });
  $('#download-eml').addEventListener('click',()=>{ const html=getTemplate().buildHtml(currentConfig); const eml=buildEml($('#to').value.trim(),$('#subject').value.trim(),html); const name=($('#subject').value||'project-update').toLowerCase().replace(/[^a-z0-9]+/g,'-'); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([eml],{type:'message/rfc822'})); a.download=`${name}.eml`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1200); });
  $('#open-outlook-web').addEventListener('click',()=>{ const html=getTemplate().buildHtml(currentConfig); const base='https://outlook.office.com/mail/deeplink/compose'; const url=`${base}?to=${encodeURIComponent($('#to').value||'')}&subject=${encodeURIComponent($('#subject').value||'')}&body=${encodeURIComponent(html)}&mailBodyType=html`; window.open(url,'_blank'); });
  $('#proj-export').addEventListener('click',()=>{ const p=store.projects[currentProjectId]; const data=JSON.stringify(p,null,2); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([data],{type:'application/json'})); a.download=`${(p.name||'project').toLowerCase().replace(/[^a-z0-9]+/g,'-')}.json`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1200); });
  $('#proj-import').addEventListener('click',()=> $('#proj-import-file').click());
  $('#proj-import-file').addEventListener('change',()=>{ const f=$('#proj-import-file').files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const p=JSON.parse(r.result); if(p&&p.id&&Array.isArray(p.versions)){ store.projects[p.id]=p; saveStore(); openProject(p.id);} else alert('Invalid project JSON'); }catch(e){ alert('Import failed: '+e.message);} $('#proj-import-file').value=''; }; r.readAsText(f); });
  $('#proj-delete').addEventListener('click',()=>{ if(confirm('Delete entire project?')){ delete store.projects[currentProjectId]; saveStore(); renderDashboard(); }});
  projNameInput.addEventListener('input',()=>{ const p=store.projects[currentProjectId]; p.name=projNameInput.value||p.name; p.updatedAt=Date.now(); saveStore(); });
  editor.addEventListener('input',()=>{});

  // Init
  loadStore(); renderDashboard();
})();




